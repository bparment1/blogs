---
title: "Raster Change Analysis with two images"
author: "Benoit Parmentier"
date: "7/15/2018"
output: 
  html_document:
    #theme: null
    #highlight: null
    #css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp) # spatial/geographfic objects and functions
library(rasterVis) # raster visualization operations
library(raster) # raster functionalities
library(rgeos) #contains topological operations
library(sf) # spatial objects classes
library(plotrix) #various graphic functions e.g. draw.circle
library(colorRamps) #contains matlab.like color palette

```

## Raster Change analysis with Two dates: Hurricane RITA

This blog provides a simple example of change analysis using remotely sensed images from two dates. We use two images from the MODIS Terra Sensor (MOD09) to examine if the impact of Hurricane Rita is visible on the ground. Hurricane Rita is a category 3 hurricane that made landfall on September 24, 2005 in the southwest Louisiana coast. The hurricane generated a surge of more than 4 meters than resuldated in flooding in several areas along the coast.

I downloaded and processed MOD09 images for the date before and after hurricane Rita. The data was screened for unreliable pixels and aggregated at a 1km to deal with missing values (upcoming blogs on the flag processing!)

### Setting up input parameters and directories

First let us set up the input directories. It is good practice to concentrate all the variables and input parameters at the
start of the script. We also create an output directory that can change for each analysis (using output suffix as identifier).


```{r }

############################################################################
#####  Parameters and argument set up ###########

#Note: https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20170008750.pdf
out_suffix <- "change_" #output suffix for the files and ouptut folder #param 1

#in_dir <- "./blogs/blog1_basic_change_analysis/data/"
#out_dir <- "./blogs/blog1_basic_change_analysis/outputs"

in_dir <- "/nfs/bparmentier-data/Data/blogs/blog1_basic_change_analysis/data/"
out_dir <- "/nfs/bparmentier-data/Data/blogs/blog1_basic_change_analysis/outputs"

file_format <- ".tif" #PARAM 4
NA_flag_val <- -9999 #PARAM 5
create_out_dir_param=TRUE #PARAM6

infile_reflectance_date1 <- "mosaiced_MOD09A1_A2005265__006_reflectance_masked_RITA_reg_1km.tif" #PARAM 7
infile_reflectance_date2 <- "mosaiced_MOD09A1_A2005273__006_reflectance_masked_RITA_reg_1km.tif" #PARAM 8

new_strata_rita_10282017.shp

```


### Reading in rasters and visualizing bands

We then load in the input images. We chose the dates closest to the hurricane event. The first date corresponds to September 22, 2005 (before event) and the second date to September 30 2005 (after event). We use a brick and assign the corresponding
band names. MOD09 product contains seven bands spanning the optical spectrum. More information can be found at https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table

Note that the bands are not ordered in the order of their spectral wavelengths.

```{r }

###############################################
##### PART III: Band combination: Indices and thresholding for flood mapping ##############

  
###### Read in MOD09 reflectance images before and after Hurrican Rita.
r_before <- brick(file.path(in_dir,infile_reflectance_date1)) # Before RITA, Sept. 22, 2005.
r_after <- brick(file.path(in_dir,infile_reflectance_date2)) # After RITA, Sept 30, 2005.

names(r_before) <- c("Red","NIR","Blue","Green","SWIR1","SWIR2","SWIR3")
names(r_after) <- c("Red","NIR","Blue","Green","SWIR1","SWIR2","SWIR3")

plot(r_before)
plot(r_after)

```

We note that Near Infrared and Short Wave Infrared (SWIR1 and SWIR2) often high contrast between vegetated areas and water. These bands also display changes in areas in near the coast.

### Visualization of impact using true and false color composites.

A first step in the change analysis is to visually inspect for change using bands combination. We generate color composites using RGB color compositing which requires identifying spectral bands corresponding to red (band 1), green (band 4) and blue (band 1).This generates a true color composite image similar to a color photography.

```{r , echo=TRUE}

#### Generate Color composites
### True color composite

# 4 figures arranged in 2 rows and 2 columns
#attach(mtcars)
par(mfrow=c(2,1))

plotRGB(r_before,
        r=1,
        g=4,
        b=3,
        scale=0.6,
        stretch="hist",
        main="before")

plotRGB(r_after,
        r=1,
        g=4,
        b=3,
        scale=0.6,
        stretch="hist",
        main="after")

```

A second useful step is to generate a False color composite. This is similar to a Color Infrared (CIR) photography. This may be particularly useful since we use bands that may be affected by the presence of water on the ground. Vegetation is also often studied and which can affect spectral signal from vegtation. We generate a RGB false composite which requires identifying spectral bands corresponding to red (band 2: SWIR), green (band 4) and blue (band 1).

```{r, echo=TRUE}

### False color composite:
par(mfrow=c(2,1))
plotRGB(r_before,
        r=2,
        g=1,
        b=4,
        scale=0.6,
        stretch="hist")

plotRGB(r_after,
        r=2,
        g=1,
        b=4,
        scale=0.6,
        stretch="hist")

```

Visual inspection suggest some change areas especially visible in the false color composite towards the coast the South East part of the study area. The next will be to quantitavely assess where changes occurs. We will use specific spectral bands combinations (indices) to focus on specific features from the ground. 

### Generating Indices from the original bands: NDWI

We use the original bands from MOD09 product to generate NDVI and NDWI indices the study of change. Indices are derived for both ebefore and after. There are different choices to generate a NDWI and we list from the literature: 

1) NDVI = (NIR - Red)/(NIR+Red)
2) NDWI =  (NIR - SWIR2)/(NIR + SWIR2)

NDVI is widely used to detect vegetation on the ground. We use here a modified flavor of NDWI using SWIR2 and NIR because the literature suggest these are useful to detect water fraction on the ground in the case of the MODIS sensor. We generated indices for both dates and plot maps on the same scale using the levelplot function from RasterVis.

```{r,echo=TRUE}

############## Generating indices based on raster algebra of original bands
## Let's generate a series of indices, we list a few possibility from the literature.

#3) MNDWI = Green - SWIR2 / Green + SWIR2

names(r_before)
r_before_NDVI <- (r_before$NIR - r_before$Red) / (r_before$NIR + r_before$Red)
r_after_NDVI <- subset(r_after,"NIR") - subset(r_after,"Red")/(subset(r_after,"NIR") + subset(r_after,"Red"))

#r_before_NDWI <- (r_before$Red - r_before$SWIR2) / (r_before$Red + r_before$SWIR2)
#r_after_NDWI <- (r_after$Red - r_after$SWIR2) / (r_after$Red + r_after$SWIR2)

r_before_NDWI <- (r_before$NIR - r_before$SWIR2) / (r_before$NIR + r_before$SWIR2)
r_after_NDWI <- (r_after$NIR - r_after$SWIR2) / (r_after$NIR + r_after$SWIR2)

r_NDWI_s <- stack(r_before_NDWI,r_after_NDWI)
names_panel <- c("NDWI Before event","NDWI After event")
levelplot(r_NDWI_s,
          names.attr=names_panel,
          col.regions=rev(matlab.like(255)))

#levelplot(stack(r_before_NDVI,r_after_NDVI),col.regions=rev(terrain.colors(255)))
r_NDVI_s <- stack(r_before_NDVI,r_after_NDVI)
#names(r_NDVI_s) <- c("Before event","After event")
names_panel <- c("NDVI Before Event","NDVI After Event")
levelplot(r_NDVI_s,
          names.attr = names_panel,
          col.regions=rev(terrain.colors(255)))


```

Comparison of before and after NDVI suggest a general drop in NDVI for the region while the NDWI indicate some additional pockets of water near the coasts. 

```{r,echo=T}

##### How do we map change related to event?

### Lower NIR often correlates to areas with high water fraction or inundated:

#1) Simple thresholding
#2) Difference 
#3) PCA

### 1) Simple thresholding

r_rec_NDWI_before <- subset(r_before,"NIR") < 0.2
r_rec_NDWI_after <- subset(r_after,"NIR") < 0.2

### THis is suggesting flooding!!!
plot(r_rec_NDWI_before, main="Before RITA, NDWI > 0.2")
plot(r_rec_NDWI_after, main="After RITA, NDWI > 0.2")

#Compare to actual flooding data
#freq_fema_zones <- as.data.frame(freq(r_ref))
#xtab_threshold <- crosstab(r_ref,r_rec_NIR_after,long=T)

## % overlap between the flooded area and values below 0.2 in NIR
#(xtab_threshold[5,3]/freq_fema_zones[2,2])*100 #agreement with FEMA flooded area in %.

### 2) Difference

r_diff <- r_after_NDWI - r_before_NDWI

plot(r_diff)
histogram(r_diff)

r_std <- (r_diff - cellStats(r_diff,"mean"))/cellStats(r_diff,"sd")

threshold_val <- c(1.96,1.64)
plot(r_std)
hist(r_std)
abline(v=threshold_val[1],col="red",tly=1)
abline(v=-threshold_val[1],col="red",tly=1)

r_change_pos <- r_std > treshold_val[1]
r_change_neg <- r_std < -threshold_val[1]

plot(r_change_pos)
plot(r_change_neg)

#shapiro.test(as.vector(r_diff))


### Generate a map of flooding with MNDWI and compare to FEMA map:

r_after_flood <- r_diff_std > 1 
plot(r_after_flood)

#reclass in zero/1!!!

df <- data.frame(id=c(1,2), v=c(0,1))
r_ref_rec <- subs(r_ref, df)
plot(r_ref_rec)
xtab_tb <- crosstab(r_after_flood,r_ref_rec)

## Examine overlap between flooded area and FEMA:

plot(r_after_flood)
r_overlap <- r_ref_rec * r_after_flood
plot(r_overlap) ## Flood map area of aggreement with FEMA

```

##############



